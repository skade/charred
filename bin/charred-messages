require 'tinder'
require 'term/ansicolor'
require 'shellwords'

include Term::ANSIColor

campfire = Tinder::Campfire.new ARGV[0], :token => ARGV[1]

room = campfire.rooms.first

def handle_message(m, display = true )
  if m.type == "TextMessage"
    print green { bold { m.user.name } }
    print blue { bold { ": " } }
    print white { m.body }, "\n"
    message = Shellwords.escape(m.user.name + ": " + m.body)
    system("tmux display-message #{message}") if display
  elsif m.type == "TimestampMessage"
    print yellow { bold { m.created_at.strftime("%T") } }, "\n"
  else
    print red { "unhandled message #{m.inspect} \n" }
  end
end

room.recent.each { |m| handle_message(m, false) }
room.listen { |m| handle_message(m) }
